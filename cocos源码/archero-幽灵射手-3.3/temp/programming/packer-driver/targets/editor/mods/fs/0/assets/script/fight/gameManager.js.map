{"version":3,"sources":["file:///Users/ykq/Downloads/archero/assets/script/fight/gameManager.ts"],"names":["_decorator","Component","Node","CameraComponent","Vec3","SkeletalAnimationComponent","ParticleSystemComponent","AnimationComponent","find","EffectManager","clientEvent","playerData","Monster","uiManager","MapManager","GameCamera","Player","resourceUtil","poolManager","constant","localConfig","AudioManager","ccclass","property","GameManager","type","isWin","value","_isWin","isGameStart","dispatchEvent","EVENT_TYPE","ON_GAME_OVER","gameSpeed","console","log","_gameSpeed","refreshEffectSpeed","ndGameManager","ndPlayer","ndEffectManager","onEnable","on","ON_GAME_INIT","_onGameInit","_onGameOver","ON_GAME_PAUSE","_onGamePause","REFRESH_LEVEL","_refreshLevel","RECYCLE_ALL","_recycleAll","onDisable","off","start","mainCamera","camera","getComponent","scriptGameCamera","node","ndMapManager","_oriMainLightWorPos","ndLight","worldPosition","clone","isTesting","window","instance","level","playerInfo","totalLevel","getTableArr","length","mapInfo","queryByID","String","attackAddition","defenseAddition","hpAddition","moveSpeedAddition","attackSpeedAddition","showDialog","HIDE_WARP_GATE","isGamePause","isGameOver","isRevive","arrMonster","ndBoss","existentNum","addFightTimes","pauseAll","arrMap","mapName","split","Math","floor","random","preloadMonsterSkill","then","_loadMap","_createPlayer","scriptPlayer","resetPlayerState","HIDE_LOADING_PANEL","cb","scriptMapManager","buildMap","loadModelRes","pf","getNode","ndFollowTarget","init","isFirstLoad","preloadArrow","recycle","i","children","ndChild","name","putNode","hideDialog","nextLevel","Number","highestLevel","getNearestMonster","offsetA","offsetB","playerWorPos","arr","sort","a","b","distanceA","subtract","distanceB","filter","item","scriptMonster","parent","isDie","scriptBoss","getNearbyMonster","ndMonster","isAll","range","offsetPos","concat","push","index","idx","targetNode","arrAni","getComponentsInChildren","forEach","clips","clip","aniName","aniState","getState","speed","arrSkeletalAni","arrParticle","simulationSpeed","addGold","updatePlayerInfo","ceil","REFRESH_GOLD","arrName","Promise","resolve","reject","arrLoadSkill","arrInfo","ID","startsWith","element","arrSkill","skill","id","arrMonsterSkill","indexOf","arrPromise","skillInfo","p","loadEffectRes","resName","prefab","ndSkillCollider","setWorldPosition","x","z","all","catch","e","error","checkTriggerAll","SHOW_WARP_GATE","update","deltaTime","_offsetWorPosMainLight","set","add"],"mappings":"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","sourcesContent":["import { EffectManager } from './../framework/effectManager';\nimport { clientEvent } from './../framework/clientEvent';\nimport { playerData } from './../framework/playerData';\nimport { Monster } from './monster';\nimport { uiManager } from './../framework/uiManager';\nimport { MapManager } from './mapManager';\nimport { _decorator, Component, Node, CameraComponent, Vec3, SkeletalAnimationComponent, ParticleSystemComponent, AnimationComponent, find, resources, Prefab, error, BoxColliderComponent, RigidBodyComponent, MeshRenderer, Mesh } from 'cc';\nimport { GameCamera } from './gameCamera';\nimport { Player } from './player';\nimport { resourceUtil } from '../framework/resourceUtil';\nimport { poolManager } from '../framework/poolManager';\nimport { constant } from '../framework/constant';\nimport { localConfig } from '../framework/localConfig';\nimport { Boss } from './boss';\nimport { AudioManager } from '../framework/audioManager';\nconst { ccclass, property } = _decorator;\n\n@ccclass('GameManager')\nexport class GameManager extends Component {\n    @property(GameCamera)\n    public camera: GameCamera = null!;//相机组件\n\n    @property({type: MapManager})\n    public scriptMapManager: MapManager = null!;//地图脚本组件\n\n    @property(Node)\n    public ndLight: Node = null!; //主光源\n\n    public mapInfo: any = {};//地图信息\n    public arrMonsterSkill: any[] = [];//已经预加载的敌人技能\n\n    public static mainCamera: CameraComponent | null = null;//相机组件\n    public static isGameStart: boolean = false;//游戏是否开始\n    public static isGamePause: boolean = false;//游戏是否暂停\n    public static isGameOver: boolean = false;//游戏是否结束\n    public static scriptPlayer: Player = null!;//玩家脚本\n    public static scriptGameCamera: GameCamera;//相机脚本\n    public static ndPlayer: Node = null!;//玩家节点\n    public static ndBoss: Node = null!;//小怪节点\n    public static scriptBoss: Boss = null!;//boss脚本\n    public static ndGameManager: Node;//游戏全局管理节点\n    public static ndEffectManager: Node = null!;//特效节点\n    public static ndMapManager: Node = null!;//地图节点\n    public static isRevive: boolean = false;//玩家是否复活\n    public static isTesting: boolean = true;//是否开启测试代码\n    public static isFirstLoad: boolean = false;//是否首次加载\n    public static arrMonster: Node[] = []; //小怪、boss数组\n    public static existentNum: number = 0;//本层加载的npc、大爱心现存数量（怪物不会和npc、大爱心同时出现，配置表格需注意）\n    //本层敌人加成\n    public static attackAddition: number = 1;//本层敌人攻击加成\n    public static defenseAddition: number = 1;//本层敌人防御加成\n    public static hpAddition: number = 1;//本层敌人生命加成\n    public static moveSpeedAddition: number = 1;//本层敌人移速加成\n    public static attackSpeedAddition: number = 1;//本层敌人攻速加成\n\n    public static set isWin (value: boolean) {\n        this._isWin = value;\n\n        if (GameManager.isGameStart) {\n            clientEvent.dispatchEvent(constant.EVENT_TYPE.ON_GAME_OVER);            \n        }\n    }\n\n    public static get isWin () {\n        return this._isWin;\n    }\n\n    public static set gameSpeed (value: number) {\n        console.log(\"gameSpeed\",GameManager.gameSpeed);\n\n        this._gameSpeed = value;\n        GameManager.refreshEffectSpeed(GameManager.ndGameManager, this._gameSpeed);\n        GameManager.refreshEffectSpeed(GameManager.ndPlayer as Node, this._gameSpeed);\n        GameManager.refreshEffectSpeed(GameManager.ndEffectManager as Node, this._gameSpeed);\n    };\n\n    public static get gameSpeed () {\n        return this._gameSpeed;\n    }\n\n    private _oriMainLightWorPos: Vec3 = null!;//主光源节点初始世界坐标\n    private _offsetWorPosMainLight: Vec3 = new Vec3();//主光源和玩家的向量差\n\n    private static _gameSpeed: number = 1;//游戏速度\n    private static _isWin: boolean = false;//是否取得胜利\n\n    onEnable () {\n        clientEvent.on(constant.EVENT_TYPE.ON_GAME_INIT, this._onGameInit, this);\n        clientEvent.on(constant.EVENT_TYPE.ON_GAME_OVER, this._onGameOver, this);\n        clientEvent.on(constant.EVENT_TYPE.ON_GAME_PAUSE, this._onGamePause, this);\n        clientEvent.on(constant.EVENT_TYPE.REFRESH_LEVEL, this._refreshLevel, this);\n        clientEvent.on(constant.EVENT_TYPE.RECYCLE_ALL, this._recycleAll, this);\n    }\n\n    onDisable () {\n        clientEvent.off(constant.EVENT_TYPE.ON_GAME_INIT, this._onGameInit, this);\n        clientEvent.off(constant.EVENT_TYPE.ON_GAME_OVER, this._onGameOver, this);\n        clientEvent.off(constant.EVENT_TYPE.ON_GAME_PAUSE, this._onGamePause, this);\n        clientEvent.off(constant.EVENT_TYPE.REFRESH_LEVEL, this._refreshLevel, this);\n        clientEvent.off(constant.EVENT_TYPE.RECYCLE_ALL, this._recycleAll, this);\n    }\n\n    start () {\n        GameManager.mainCamera = this.camera?.getComponent(CameraComponent) as CameraComponent;\n        GameManager.scriptGameCamera = this.camera?.getComponent(GameCamera) as GameCamera;\n        GameManager.ndGameManager = this.node;\n        GameManager.ndMapManager = find(\"mapManager\") as Node;\n        GameManager.ndEffectManager = find(\"effectManager\") as Node;\n\n        this._oriMainLightWorPos = this.ndLight.worldPosition.clone();\n\n        if (GameManager.isTesting) {\n            //@ts-ignore\n            window.uiManager = uiManager.instance;      \n            //@ts-ignore\n            window.AudioManager = AudioManager.instance;\n            //@ts-ignore\n            window.playerData = playerData.instance;\n            //@ts-ignore\n            window.clientEvent = clientEvent;      \n            //@ts-ignore\n            window.ndGameManager = GameManager.ndGameManager;\n            //@ts-ignore\n            window.GameManager = GameManager;\n            //@ts-ignore\n            window.ndMapManager = GameManager.ndMapManager;\n            //@ts-ignore\n            window.EffectManager = EffectManager.instance;\n            //@ts-ignore\n            window.ndEffectManager = GameManager.ndEffectManager;\n            //@ts-ignore\n            window.constant = constant;\n            //@ts-ignore\n            //@ts-ignore\n        }\n    }\n\n    /**\n     * 初始化游戏\n     */\n    private _onGameInit () {   \n        let level = playerData.instance.playerInfo.level;\n\n        let totalLevel = localConfig.instance.getTableArr(\"checkpoint\").length;\n        //游戏通关后从倒数第10关开始循环(61-70)\n        if (level > totalLevel) {\n            level = (totalLevel - 10) + (level - totalLevel) % 10;  \n        } \n        \n        this.mapInfo = localConfig.instance.queryByID(\"checkpoint\", String(level));\n        //设置本层敌人属性加成比例\n        GameManager.attackAddition = this.mapInfo.attackAddition;\n        GameManager.defenseAddition = this.mapInfo.defenseAddition;\n        GameManager.hpAddition = this.mapInfo.hpAddition;\n        GameManager.moveSpeedAddition = this.mapInfo.moveSpeedAddition;\n        GameManager.attackSpeedAddition = this.mapInfo.attackSpeedAddition;\n\n        uiManager.instance.showDialog(\"loading/loadingPanel\");\n\n        clientEvent.dispatchEvent(constant.EVENT_TYPE.HIDE_WARP_GATE);\n\n        GameManager.isGameStart = false;\n        GameManager.isGamePause = false;\n        GameManager.isGameOver = false;    \n        GameManager.isWin = false;\n        GameManager.isRevive = false;\n        GameManager.arrMonster = [];\n        GameManager.gameSpeed = 1;\n        GameManager.ndBoss = null!;\n        GameManager.existentNum = 0;\n\n        playerData.instance.addFightTimes();\n\n        AudioManager.instance.pauseAll();\n\n        this._refreshLevel();\n    }\n\n    /**\n     * 刷新关卡, 后期优化写法。。。\n     */\n    private _refreshLevel () {\n        //每层随机一张地图\n        let arrMap = this.mapInfo.mapName.split(\"#\");\n        let mapName = arrMap[Math.floor(Math.random() * arrMap.length)];\n        \n        this.preloadMonsterSkill(mapName).then(()=>{\n            this._recycleAll();\n            this._loadMap(mapName, ()=>{\n                //第一次进入或者失败后被销毁需要重新创建\n                if (!GameManager.ndPlayer) {\n                    this._createPlayer();\n                } else {\n                    GameManager.scriptPlayer.resetPlayerState();\n                    clientEvent.dispatchEvent(constant.EVENT_TYPE.HIDE_LOADING_PANEL);\n                }\n            });\n        })\n    }\n\n    /**\n     * 加载地图数据\n     *\n     * @private\n     * @param {Function} [cb=()=>{}]\n     * @memberof GameManager\n     */\n    private _loadMap (mapName: string, cb: Function = ()=>{}) {   \n        this.scriptMapManager.buildMap(mapName, ()=>{}, ()=>{\n            cb && cb();\n        })\n    }\n\n    /**\n     * 创建玩家\n     *\n     * @private\n     * @memberof GameManager\n     */\n    private _createPlayer () {      \n        resourceUtil.loadModelRes(\"player/player01\").then((pf: any)=>{\n            GameManager.ndPlayer = poolManager.instance.getNode(pf, this.node) as Node;\n            \n            let scriptGameCamera = GameManager.mainCamera?.node.getComponent(GameCamera) as GameCamera;\n            scriptGameCamera.ndFollowTarget = GameManager.ndPlayer;\n\n            let scriptPlayer = GameManager.ndPlayer?.getComponent(Player) as Player;\n            GameManager.scriptPlayer = scriptPlayer;\n            scriptPlayer?.init();\n\n            //初次进入的时候需要预加载弓箭\n            if (GameManager.isFirstLoad) {\n                GameManager.isFirstLoad = false;\n\n                scriptPlayer.preloadArrow(()=>{\n                    clientEvent.dispatchEvent(constant.EVENT_TYPE.HIDE_LOADING_PANEL);\n                })\n            } else {\n                clientEvent.dispatchEvent(constant.EVENT_TYPE.HIDE_LOADING_PANEL);\n            }\n        })\n    }\n\n    /**\n     * 回收怪兽, 武器，特效等\n     *\n     * @private\n     * @memberof GameManager\n     */\n    private _recycleAll () {\n        this.scriptMapManager.recycle();\n\n        for (let i = this.node.children.length - 1; i >= 0; i--) {\n            const ndChild = this.node.children[i];\n            if (ndChild.name !== \"player01\") {\n                poolManager.instance.putNode(ndChild);\n            }\n        }\n\n        while(GameManager.ndEffectManager.children.length) {\n            poolManager.instance.putNode(GameManager.ndEffectManager.children[0]);\n        }\n    }\n\n    /**\n     * 游戏结束\n     */\n    private _onGameOver () {\n        if (GameManager.isGameOver) {\n            return;\n        }\n\n        GameManager.isGamePause = true;\n\n        console.log(\"game over!\", \"isWin ?\", GameManager.isWin);\n\n        uiManager.instance.hideDialog(\"fight/fightPanel\");\n\n        if (GameManager.isWin) {\n            GameManager.isGameOver = true;\n\n            this._recycleAll();\n\n            let nextLevel = Number( playerData.instance.playerInfo.level) + 1;\n            playerData.instance.playerInfo.level = nextLevel;\n\n            //更新已解锁最高层级\n            if (nextLevel > playerData.instance.playerInfo.highestLevel) {\n                playerData.instance.playerInfo.highestLevel = nextLevel;\n            }\n\n            clientEvent.dispatchEvent(constant.EVENT_TYPE.ON_GAME_INIT);\n        } else {            \n            uiManager.instance.showDialog(\"revive/revivePanel\", [()=>{\n                if (GameManager.ndPlayer) {\n                    poolManager.instance.putNode(GameManager.ndPlayer);\n                    GameManager.ndPlayer = null!;\n                    GameManager.scriptPlayer = null!;\n                }\n\n                this._recycleAll();\n            }]);\n        }\n    }\n\n    /**\n     * 游戏暂停\n     */\n    private _onGamePause () {\n        GameManager.isGamePause = true;\n    }\n\n    /**\n     * 获取距离最近的小怪、boss节点\n     * @returns \n     */\n    public static getNearestMonster () {\n        if (GameManager.arrMonster.length) {\n            let offsetA: Vec3 = new Vec3();\n            let offsetB: Vec3 = new Vec3();\n    \n            let playerWorPos = GameManager.ndPlayer?.worldPosition as Vec3;\n            let arr = GameManager.arrMonster.sort((a: any, b: any)=>{\n                let distanceA = Vec3.subtract(offsetA, playerWorPos, a.worldPosition).length();\n                let distanceB = Vec3.subtract(offsetB, playerWorPos, b.worldPosition).length();\n                return  distanceA - distanceB;\n            })\n    \n            arr = arr.filter((item: Node)=>{\n                let scriptMonster = item.getComponent(Monster) as Monster;\n                return item.parent !== null && !scriptMonster.isDie;\n            })\n\n            return arr[0];\n        } else if (GameManager.ndBoss && !GameManager.scriptBoss.isDie) {\n            return GameManager.ndBoss;\n        } else {\n            return null;\n        }\n    }\n\n    /**\n     * 获取除了怪物本身自己外一定范围内的怪物\n     *\n     * @static\n     * @param {Node} ndMonster 被击中的敌人\n     * @param {boolean} [isAll=false] 是否返回全部敌人,否则只随机返回一个\n     * @param {number} [range=5] 范围\n     * @return {*} \n     * @memberof GameManager\n     */\n    public static getNearbyMonster (ndMonster: Node, isAll: boolean = false, range: number = 5) {\n        //范围\n        let arrMonster: any[] = [];\n        let offsetPos: Vec3 = new Vec3();\n\n        if (GameManager.arrMonster.length) {\n            arrMonster = GameManager.arrMonster.concat();\n        } \n\n        if (GameManager.ndBoss) {\n            arrMonster.push(GameManager.ndBoss);\n        } \n\n        arrMonster = arrMonster.filter((item: Node)=>{\n            let scriptMonster = item.getComponent(Monster) as Monster;\n            Vec3.subtract(offsetPos, ndMonster.worldPosition, item.worldPosition);\n            return item.parent !== null && !scriptMonster.isDie && offsetPos.length() <= range && ndMonster.worldPosition !== item.worldPosition;\n        })\n\n        if (arrMonster.length) {\n            if (!isAll) {\n                let index = Math.floor(Math.random() * arrMonster.length);\n                return arrMonster = arrMonster.filter((ndChild: Node, idx: number)=>{\n                    return idx === index;\n                })\n            } else {\n                return arrMonster;\n            }\n        } else {\n            return arrMonster;\n        }\n    }\n\n    /**\n     * 刷新自节点的动画、粒子播放速度\n     * @param targetNode \n     * @param value \n     * @returns \n     */\n     public static refreshEffectSpeed (targetNode: Node, value: number) {\n        if (!targetNode) {\n            return;\n        }   \n        let arrAni = targetNode.getComponentsInChildren(AnimationComponent);\n        arrAni.forEach((item: AnimationComponent)=>{\n            item.clips.forEach((clip: any)=>{\n                let aniName = clip?.name as string\n                let aniState = item.getState(aniName);\n                aniState.speed = value;\n            })\n        })\n\n        let arrSkeletalAni = targetNode.getComponentsInChildren(SkeletalAnimationComponent);\n        arrSkeletalAni.forEach((item: SkeletalAnimationComponent)=>{\n            item.clips.forEach((clip: any)=>{\n                let aniName = clip?.name as string\n                let aniState = item.getState(aniName);\n                aniState.speed = value;\n            })\n        })\n\n        let arrParticle = targetNode.getComponentsInChildren(ParticleSystemComponent);\n        arrParticle.forEach((item: ParticleSystemComponent)=>{\n            item.simulationSpeed = value;\n        })\n    }\n\n    /**\n     * 添加钻石\n     *\n     * @static\n     * @param {number} [value=1]\n     * @memberof GameManager\n     */\n    public static addGold (value: number = 1) {\n        playerData.instance.updatePlayerInfo('gold', Math.ceil(value));\n        clientEvent.dispatchEvent(constant.EVENT_TYPE.REFRESH_GOLD);\n    }\n\n    /**\n     * 每层进入前预加载该层所需的敌人技能\n     *\n     * @private\n     * @memberof GameManager\n     */\n    public preloadMonsterSkill (arrName: string) {\n        return new Promise((resolve, reject)=>{\n            let arrLoadSkill: string[] = [];//等待预加载的技能\n            let arrInfo = localConfig.instance.getTableArr(arrName);\n            //获取所有敌人信息\n            arrInfo = arrInfo.filter((item: any)=>{\n                return item.ID.startsWith(\"2\");\n            })\n\n            //获得敌人技能\n            if (arrInfo.length) {\n                arrInfo.forEach((element: any) => {\n                    let arrSkill = element.skill === \"\" ? [] : element.skill.split(\"#\");\n                    arrSkill.length && arrSkill.forEach((id: string) => {\n                        if (this.arrMonsterSkill.indexOf(id) === -1) {\n                            this.arrMonsterSkill.push(id);\n                            arrLoadSkill.push(id);\n                        }\n                    });            \n                });\n\n                let arrPromise = [];\n                if (arrLoadSkill.length) {\n                    for (let i = 0; i < arrLoadSkill.length; i++) {\n                        const element = arrLoadSkill[i];  \n                        //预加载敌人技能\n                        let skillInfo = localConfig.instance.queryByID(\"monsterSkill\", element);\n                        let p = resourceUtil.loadEffectRes(`${skillInfo.resName}/${skillInfo.resName}`).then((prefab: any)=>{\n                            let ndSkillCollider = poolManager.instance.getNode(prefab, GameManager.ndGameManager as Node) as Node;\n                            ndSkillCollider.setWorldPosition(this.node.worldPosition.x, 30, this.node.worldPosition.z);\n                        })\n                        arrPromise.push(p);\n                    }\n        \n                    Promise.all(arrPromise).then(()=>{\n                        resolve(null);\n                    }).catch((e: any)=>{\n                        console.error(\"预加载敌人技能报错\", e);\n                    })\n                } else {\n                    resolve(null);\n                }\n            } else {\n                resolve(null);\n            }\n        })\n    }\n\n    /**\n     * 判断本层的爱心、npc是否都已经触发\n     *\n     * @static\n     * @memberof GameManager\n     */\n    public static checkTriggerAll () {\n        GameManager.existentNum -= 1;\n\n        if (GameManager.existentNum <= 0) {\n            clientEvent.dispatchEvent(constant.EVENT_TYPE.SHOW_WARP_GATE);\n        }\n    }\n\n    update (deltaTime: number) {\n         //光源跟随玩家人物移动\n         if (GameManager.scriptPlayer && GameManager.scriptPlayer.node && !GameManager.isGameOver) {\n            Vec3.subtract(this._offsetWorPosMainLight, GameManager.ndPlayer.worldPosition, this._oriMainLightWorPos);\n            this._offsetWorPosMainLight.set(this._offsetWorPosMainLight.x, 0, this._offsetWorPosMainLight.z);\n            this.ndLight.setWorldPosition(this._offsetWorPosMainLight.add(this._oriMainLightWorPos));\n        }\n    }\n}\n"]}