{"version":3,"sources":["file:///Users/ykq/Downloads/archero/assets/script/fight/arrow.ts"],"names":["_decorator","Component","Node","Vec3","ParticleSystemComponent","math","AudioManager","util","GameManager","poolManager","resourceUtil","constant","ccclass","property","Arrow","start","init","speed","releaseWorPos","_releaseWorPos","set","_ndBody","node","getChildByName","_isLoadEffectOver","_isNeedShowEffect","isArrowLaunch","_oriPos","position","clone","_oriEulerAngles","eulerAngles","_oriForward","forward","active","setPosition","_curForward","_targetSpeed","_curSpeed","children","forEach","ndChild","name","startsWith","isHasIce","scriptPlayer","isArrowIce","isHasFire","isArrowFire","isHasLightning","isArrowLightning","_showTrail","instance","playSound","SOUND","FIRE","LIGHTNING","ICE","isGameStart","LOOSE","effectName","ndTrail","loadEffectRes","then","pf","getNode","recycleArrowGroup","parent","putNode","hideArrow","arrParticle","getComponentsInChildren","item","simulationSpeed","clear","stop","isAllArrowHide","every","ndArrow","playArrowLaunch","ndMonster","arrTargets","getNearbyMonster","length","ndTarget","_offsetPos_1","x","worldPosition","z","_offsetPos_2","radian","angle","toDegree","cross","_cross","y","_curEulerAngles","update","deltaTime","ndPlayer","isGameOver","isGamePause","lerp","_targetWorPos","translate","NodeSpace","LOCAL","_curWorPos","subtract","_offsetPos","_disappearRange"],"mappings":"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","sourcesContent":["import { AudioManager } from './../framework/audioManager';\nimport { util } from './../framework/util';\nimport { GameManager } from './gameManager';\nimport { poolManager } from './../framework/poolManager';\nimport { _decorator, Component, Node, Vec3, Quat, ParticleSystemComponent, math } from 'cc';\nimport { resourceUtil } from '../framework/resourceUtil';\nimport { constant } from '../framework/constant';\n//单只弓箭组件\nconst { ccclass, property } = _decorator;\n@ccclass('Arrow')\nexport class Arrow extends Component {\n    public isAutoRotate: boolean = true;//箭是否自动调整角度\n    public isArrowLaunch: boolean = false;//箭是否弹射\n    // public isArrowRebound: boolean = false;//箭是否在墙上反弹\n    // public arrowReboundTimes: number = 0;//箭反弹次数\n    \n    private _ndBody: Node = null!;//放弓箭特效的节点\n    private _curSpeed: number = 0;//当前速度\n    private _targetSpeed: number = 0;//目标速度\n    private _oriPos: Vec3 = null!;//初始默认位置\n    private _oriEulerAngles: Vec3 = null!//初始默认角度\n    private _offsetPos: Vec3 = new Vec3();//和玩家之间的向量差\n    private _curWorPos: Vec3 = new Vec3();//当前节点世界坐标\n    private _disappearRange: number = 25;//箭节点超过玩家这个范围则隐藏\n    private _isLoadEffectOver: boolean = false;//是否已经加载完所有特效\n    private _isNeedShowEffect: boolean = false;//是否需要特效\n    private _targetWorPos: Vec3 = new Vec3();//箭的下次目标位置\n    private _curEulerAngles: Vec3 = new Vec3();//当前角度\n    private _oriForward: Vec3 = null!;//初始朝向\n    private _curForward: Vec3 = new Vec3();//当前朝向\n    private _releaseWorPos: Vec3 = new Vec3();//技能释放位置的世界坐标\n    private _offsetPos_1: Vec3 = new Vec3();//向量差\n    private _offsetPos_2: Vec3 = new Vec3();//向量差\n    private _cross: Vec3 = new Vec3();//两个向量叉乘\n    \n    start () {\n        // [3]\n    }\n\n    /**\n    * 初始化 \n    */\n    public init (speed: number, releaseWorPos: Vec3) {\n        this._releaseWorPos.set(releaseWorPos);\n\n        if (!this._ndBody) {\n            this._ndBody = this.node.getChildByName(\"body\") as Node;\n        }\n\n        this._isLoadEffectOver = false;\n        this._isNeedShowEffect = false;\n        \n        this.isArrowLaunch = false;\n        // this.isArrowRebound = false;\n        // this.arrowReboundTimes = 0;\n\n        if (!this._oriPos) {\n            this._oriPos = this.node.position.clone();\n        }\n\n        if (!this._oriEulerAngles) {\n            this._oriEulerAngles = this.node.eulerAngles.clone();\n        }\n\n        if (!this._oriForward) {\n            this._oriForward = this.node.forward.clone();\n        }\n\n        this.node.active = false;\n        this.node.setPosition(this._oriPos);\n        this.node.eulerAngles = this._oriEulerAngles;\n        this._curForward.set(this._oriForward);\n\n        this._targetSpeed = speed;\n        this._curSpeed = speed * 0.5;\n\n        this._ndBody.children.forEach((ndChild: Node)=>{\n            if (ndChild.name.startsWith(\"arrow\") ) {\n                ndChild.active = false;\n            }\n        })\n\n        let isHasIce = GameManager.scriptPlayer.isArrowIce;\n        let isHasFire = GameManager.scriptPlayer.isArrowFire;\n        let isHasLightning = GameManager.scriptPlayer.isArrowLightning;\n\n        //根据玩家拥有的不同技能展示对应特效\n        if (isHasFire || isHasIce || isHasLightning) {\n            this._isNeedShowEffect = true;\n           \n            if (isHasFire && isHasIce && isHasLightning) {\n                this._showTrail(\"arrowAll\");\n            } else {\n                if (isHasFire && isHasIce || isHasFire && isHasLightning || isHasIce && isHasLightning) {\n                    if (isHasFire && isHasIce) {\n                        this._showTrail(\"arrowFireIce\");\n                        AudioManager.instance.playSound(constant.SOUND.FIRE);  \n                    } else if (isHasLightning && isHasFire) {\n                        this._showTrail(\"arrowLightningFire\");\n                        AudioManager.instance.playSound(constant.SOUND.LIGHTNING);  \n                    } else if (isHasLightning && isHasIce) {\n                        this._showTrail(\"arrowLightningIce\");\n                        AudioManager.instance.playSound(constant.SOUND.ICE);  \n                    }\n                } else {\n                    if (isHasFire) {\n                        this._showTrail(\"arrowFire\");\n                        AudioManager.instance.playSound(constant.SOUND.FIRE);  \n                    } else if (isHasIce) {\n                        this._showTrail(\"arrowIce\");\n                        AudioManager.instance.playSound(constant.SOUND.ICE);  \n                    } else if (isHasLightning) {\n                        this._showTrail(\"arrowLightning\");\n                        AudioManager.instance.playSound(constant.SOUND.LIGHTNING);  \n                    }\n                }\n            }\n        } else {\n            //不展示特效\n            this._ndBody.children.forEach((ndChild: Node)=>{\n                if (ndChild.name.startsWith(\"arrow\")) {\n                    ndChild.active = false;\n                }\n            })\n\n            this.node.active = true;\n            \n            if (GameManager.isGameStart) {\n                AudioManager.instance.playSound(constant.SOUND.LOOSE);  \n            }\n        }\n    }\n\n    /**\n     * 展示箭的特效拖尾\n     *\n     * @private\n     * @param {string} effectName\n     * @memberof Arrow\n     */\n    private _showTrail (effectName: string) {\n        let ndTrail: Node | null = this._ndBody.getChildByName(effectName);\n        if (ndTrail) {\n            ndTrail.active = true;\n            this.node.active = true;\n            this._isLoadEffectOver = true;\n        } else {\n            resourceUtil.loadEffectRes(`arrow/${effectName}`).then((pf: any)=>{\n                ndTrail = poolManager.instance.getNode(pf, this._ndBody);\n                this.node.active = true;\n                this._isLoadEffectOver = true;\n            });\n        }\n    }\n\n    /**\n     *  回收弓箭组，在weapon/arrow下\n     *\n     * @memberof Arrow\n     */\n    public recycleArrowGroup () {\n        if (this.node.parent) {\n            poolManager.instance.putNode(this.node.parent);\n        }\n    }\n\n    /**\n     * 击中目标,隐藏箭\n     *\n     * @memberof Arrow\n     */\n    public hideArrow () {\n        if (!this.node.parent) {\n            return;\n        }\n\n        //清除拖尾特效残留\n        let arrParticle:  ParticleSystemComponent[]= this._ndBody.getComponentsInChildren(ParticleSystemComponent);\n        arrParticle.forEach((item: ParticleSystemComponent)=>{\n            item.simulationSpeed = 1;\n            item?.clear();\n            item?.stop();\n        })\n\n        this.node.active = false;\n\n        //如果弓箭组里所有的箭都隐藏了则回收整个弓箭组\n        let isAllArrowHide = this.node.parent?.children.every((ndArrow: Node)=>{\n            return ndArrow.active === false;\n        })\n\n        if (isAllArrowHide) {\n            this.recycleArrowGroup();\n        }\n    }\n\n    /**\n     * 箭弹射给一定范围内的某个敌人\n     *\n     * @param {Node} ndMonster\n     * @memberof Arrow\n     */\n    public playArrowLaunch (ndMonster: Node) {\n        this.isArrowLaunch = true;\n\n        let arrTargets =  GameManager.getNearbyMonster(ndMonster);\n        \n        if (arrTargets.length) {\n            let ndTarget = arrTargets[0];\n            this._offsetPos_1.set(this._releaseWorPos.x - this.node.worldPosition.x, 0, this._releaseWorPos.z - this.node.worldPosition.z);\n            this._offsetPos_2.set(this.node.worldPosition.x - ndTarget.worldPosition.x, 0, this.node.worldPosition.z - ndTarget.worldPosition.z);\n            //两个向量之间弧度\n            let radian = Vec3.angle(this._offsetPos_1, this._offsetPos_2);\n            //角度\n            let angle = math.toDegree(radian);\n            //叉乘\n            Vec3.cross(this._cross, this._offsetPos_1, this._offsetPos_2);\n            //判断正反角度\n            if (this._cross.y > 0) {\n                this._curEulerAngles.y = angle;\n            } else {\n                this._curEulerAngles.y = -angle;\n            }\n\n            this.node.eulerAngles = this._curEulerAngles;\n        }\n    }\n\n    //箭在目标墙上反弹\n    // public playArrowRebound (ndArrow: Node, ndObstacle: Node) {\n    //     this.arrowReboundTimes += 1;\n    //     //碰撞面对应的法向量\n    //     let v_normal_1 = new Vec3();\n    //     //旋转后的法向量\n    //     let v_normal_2 = new Vec3();\n    //     if (ndObstacle.name == \"collider1\" || ndObstacle.name === \"collider2\") {\n    //         v_normal_1.set(1, 0, 0);\n    //     } else {\n    //         v_normal_1.set(0, 0, 1);\n    //     }\n\n    //     //旋转一定弧度后的法线\n    //     Vec3.rotateY(v_normal_2, v_normal_1, new Vec3(), ndObstacle.parent!.eulerAngles.y);\n    //     //箭和法线之间的弧度\n    //     let radian = Vec3.angle(v_normal_2, new Vec3(ndArrow.worldPosition.x, 0, ndObstacle.parent!.worldPosition.z));\n    //     let angle = math.toDegree(radian);\n\n    //     if (angle > 90) {\n    //         angle = -270 + angle;\n    //     } else {\n    //         angle = 90 + angle;\n    //     }\n        \n    //     this._curEulerAngles.y = angle;\n    //     this.node.eulerAngles = this._curEulerAngles;\n    // }\n\n    update (deltaTime: number) {\n        if (!this.node.parent || !GameManager.ndPlayer || GameManager.isGameOver || GameManager.isGamePause || (this._isNeedShowEffect && !this._isLoadEffectOver)) {\n            return;\n        }\n\n        //朝forward方向飞行\n        this._curSpeed = util.lerp(this._targetSpeed, this._curSpeed, 0.25);\n        this._targetWorPos.set(0, 0, -deltaTime * this._curSpeed);\n        this.node.translate(this._targetWorPos, Node.NodeSpace.LOCAL);\n        this._curWorPos.set(this.node.worldPosition);\n\n        //超过玩家一定范围则隐藏\n        Vec3.subtract(this._offsetPos, this._curWorPos, GameManager.ndPlayer.worldPosition);\n        if (this._offsetPos && this._offsetPos.length() >= this._disappearRange) {\n            this.hideArrow();\n        }\n    }\n}"]}