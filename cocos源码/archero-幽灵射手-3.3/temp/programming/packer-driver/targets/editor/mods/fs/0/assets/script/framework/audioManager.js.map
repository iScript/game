{"version":3,"sources":["file:///Users/ykq/Downloads/archero/assets/script/framework/audioManager.ts"],"names":["_decorator","Node","AudioClip","AudioSource","game","director","StorageManager","resourceUtil","lodash","ccclass","property","AudioManager","instance","_instance","init","_persistRootNode","getScene","addChild","addPersistRootNode","musicVolume","getAudioSetting","soundVolume","_getAudioSource","clip","result","i","_audioSources","length","audioSource","playing","addComponent","push","node","off","EventType","ENDED","currentTime","isMusic","state","getGlobalData","playMusic","name","loop","path","loadRes","err","source","tmp","audios","volume","play","playSound","arrSound","on","remove","obj","stop","hasOwnProperty","audio","stopAll","getMusicVolume","setMusic","flag","item","pauseAll","console","log","pause","resumeAll","openMusic","setGlobalData","closeMusic","openSound","setSound","closeSound","idx","stopSingleSound"],"mappings":"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","sourcesContent":["import { util } from './util';\nimport { _decorator, Component, Node, AudioClip, sys, AudioSource, game, director } from \"cc\";\nimport { StorageManager } from \"./storageManager\";\nimport { resourceUtil } from \"./resourceUtil\";\nimport { lodash } from './lodash';\nconst { ccclass, property } = _decorator;\n\ninterface AudioData {\n    source: AudioSource;\n    isMusic: boolean;\n}\n\ninterface AudioDataMap {\n    [name: string]: AudioData;\n}\n\n@ccclass(\"AudioManager\")\nexport class AudioManager {\n    private _persistRootNode: Node = null!;\n    private _audioSources: AudioSource[] = [];\n    static _instance: AudioManager;\n    dictWeaponSoundIndex: any = {};\n\n    static get instance() {\n        if (this._instance) {\n            return this._instance;\n        }\n\n        this._instance = new AudioManager();\n        return this._instance;\n    }\n\n    musicVolume: number = 0.8;\n    soundVolume: number = 1;\n    audios: AudioDataMap = {};\n    arrSound: AudioData[] = [];\n\n    init() {\n        if (this._persistRootNode) return; //避免切换场景初始化报错\n        this._persistRootNode = new Node('audio');\n        director.getScene()!.addChild(this._persistRootNode);\n        game.addPersistRootNode(this._persistRootNode)\n\n        this.musicVolume = this.getAudioSetting(true) ? 0.8 : 0;\n        this.soundVolume = this.getAudioSetting(false) ? 1 : 0;\n    }\n\n    private _getAudioSource(clip: AudioClip) {\n        let result: AudioSource | undefined;\n        for (let i = 0; i < this._audioSources.length; ++i) {\n            let audioSource = this._audioSources[i];\n            if (!audioSource.playing) {\n                result = audioSource;\n                break;\n            }\n        }\n        if (!result) {\n            result = this._persistRootNode.addComponent(AudioSource);\n            this._audioSources.push(result);\n        }\n        result.node.off(AudioSource.EventType.ENDED);\n        result.clip = clip;\n        result.currentTime = 0;\n        return result;\n    }\n\n    getAudioSetting(isMusic: boolean) {\n        let state;\n        if (isMusic) {\n            state = StorageManager.instance.getGlobalData('music');\n        } else {\n            state = StorageManager.instance.getGlobalData('sound');\n        }\n\n        // console.log('Config for [' + (isMusic ? 'Music' : 'Sound') + '] is ' + state);\n\n        return !state || state === 'true' ? true : false;\n    }\n\n    /**\n     * 播放音乐\n     * @param {String} name 音乐名称可通过constants.AUDIO_MUSIC 获取\n     * @param {Boolean} loop 是否循环播放\n     */\n    playMusic(name: string, loop: boolean) {\n        let path = 'audio/music/' + name;\n        //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // if (name !== 'click') {\n        //     path =  path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // }\n\n\n        resourceUtil.loadRes(path, AudioClip, (err: any, clip: any) => {\n            let source = this._getAudioSource(clip);\n            let tmp: AudioData = {\n                source,\n                isMusic: true,\n            };\n            this.audios[name] = tmp;\n            source.volume = this.musicVolume;\n            source.loop = loop;\n            source.play();\n        });\n    }\n\n    /**\n     * 播放音效\n     * @param {String} name 音效名称可通过constants.AUDIO_SOUND 获取\n     * @param {Boolean} loop 是否循环播放\n     */\n    playSound(name: string, loop: boolean = false) {\n        if (!this.soundVolume) {\n            return;\n        }\n\n        //音效一般是多个的，不会只有一个\n        let path = 'audio/sound/';\n        // if (name !== 'click') {\n        //     path = path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // }\n\n        resourceUtil.loadRes(path + name, AudioClip, (err: any, clip: any) => {\n            let source = this._getAudioSource(clip);\n            let tmp: AudioData = {\n                source,\n                isMusic: false,\n            };\n            this.arrSound.push(tmp);\n\n            if (loop) {\n                this.audios[name] = tmp;\n            }\n\n            source.volume = this.soundVolume;\n            source.loop = loop;\n            source.play();\n\n            source.node.on(AudioSource.EventType.ENDED, () => {\n                lodash.remove(this.arrSound, (obj: AudioData) => {\n                    return obj.source === tmp.source;\n                });\n            });\n        });\n    }\n\n    stop(name: string) {\n        if (this.audios.hasOwnProperty(name)) {\n            let audio = this.audios[name];\n            audio.source.stop();\n        }\n    }\n\n    stopAll() {\n        for (const i in this.audios) {\n            if (this.audios.hasOwnProperty(i)) {\n                let audio = this.audios[i];\n                audio.source.stop();\n            }\n        }\n    }\n    getMusicVolume() {\n        return this.musicVolume;\n    }\n\n    setMusic(flag: number) {\n        this.musicVolume = flag;\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item) && this.audios[item].isMusic) {\n                // this.changeState(item, flag);\n                let audio = this.audios[item];\n                audio.source.volume = this.musicVolume;\n            }\n        }\n    }\n\n    //看广告时先将音乐暂停\n    pauseAll() {\n        console.log(\"pause all music!!!\");\n\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item)) {\n                let audio = this.audios[item];\n                audio.source.pause();\n            }\n        }\n    }\n\n    resumeAll() {\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item)) {\n                let audio = this.audios[item];\n                audio.source.play();\n            }\n        }\n    }\n\n    openMusic() {\n        this.setMusic(0.8);\n        StorageManager.instance.setGlobalData('music', 'true');\n    }\n\n    closeMusic() {\n        this.setMusic(0);\n        StorageManager.instance.setGlobalData('music', 'false');\n    }\n\n    openSound() {\n        this.setSound(1);\n        StorageManager.instance.setGlobalData('sound', 'true');\n    }\n\n    closeSound() {\n        this.setSound(0);\n        StorageManager.instance.setGlobalData('sound', 'false');\n    }\n\n    setSound(flag: number) {\n        this.soundVolume = flag;\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item) && !this.audios[item].isMusic) {\n                // this.changeState(item, flag);\n                let audio = this.audios[item];\n                audio.source.volume = this.soundVolume;\n            }\n        }\n\n        for (let idx = 0; idx < this.arrSound.length; idx++) {\n            let audio = this.arrSound[idx];\n            audio.source.volume = this.soundVolume;\n        }\n    }\n\n    stopSingleSound(name: string) {\n        if (this.audios.hasOwnProperty(name) && !this.audios[name].isMusic) {\n            let audio = this.audios[name];\n            audio.source.stop();\n        }\n    }\n}\n"]}