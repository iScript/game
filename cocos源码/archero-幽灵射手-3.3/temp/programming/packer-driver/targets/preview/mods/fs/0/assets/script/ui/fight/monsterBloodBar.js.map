{"version":3,"sources":["file:///Users/ykq/Downloads/archero/assets/script/ui/fight/monsterBloodBar.ts"],"names":["_decorator","Component","UITransformComponent","tween","clamp","Vec3","find","constant","GameManager","poolManager","ccclass","property","MonsterBloodBar","start","show","scriptParent","totalBlood","offsetPos","scale","callback","isInit","_scriptParent","_totalBlood","hpAddition","_offsetPos","_ndTarget","node","_isBloodEmpty","_prevBloodPos","set","worldPosition","_curBlood","ratio","UIComWhiteBar","setContentSize","_maxWhiteBarWidth","_whiteBarHeight","UIComRedBar","_maxRedBarWidth","_redBarHeight","UIComBloodBar","priority","PRIORITY","BLOOD","refreshBlood","num","to","width","call","instance","putNode","isDie","update","parent","active","worPos","mainCamera","convertToUINode","_curPos","add","setPosition"],"mappings":"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","sourcesContent":["import { constant } from './../../framework/constant';\nimport { _decorator, Component, UITransformComponent, tween, clamp, Vec3, Node, find } from 'cc';\nimport { GameManager } from '../../fight/gameManager';\nimport { poolManager } from '../../framework/poolManager';\n\n//boss和小怪血条组件\n\nconst { ccclass, property } = _decorator;\n@ccclass('MonsterBloodBar')\nexport class MonsterBloodBar extends Component {\n    @property(UITransformComponent)\n    public UIComWhiteBar: UITransformComponent = null!;//白色进度条的UI组件\n\n    @property(UITransformComponent)\n    public UIComRedBar: UITransformComponent = null!;//血量进度条的UI组件\n\n    @property(UITransformComponent)\n    public UIComBloodBar: UITransformComponent = null!;//血量容器的UI组件\n\n    private _whiteBarHeight: number = 19;//白色进度条高度\n    private _redBarHeight: number = 19;//血量进度条高度\n    private _totalBlood: number = 0;//总的血量\n    private _curBlood: number = 0;//当前血量值\n    private _scriptParent: any = null!;//血条所在节点绑定的脚本\n    private _maxWhiteBarWidth: number = 104;//当前小怪血条中白色进度条长度\n    private _maxRedBarWidth: number = 104;//当前小怪血条中血量条长度\n    private _ndTarget: Node = null!;//跟随目标\n    private _offsetPos: Vec3 = null!;//偏差\n    private _curPos: Vec3 = new Vec3()!;//当前血条位置\n    private _isBloodEmpty: boolean = false;//血条是否为空\n    private _isStopMove: boolean = false;//是否停止移动\n    private _prevBloodPos: Vec3 = new Vec3();//血量为空前的血条位置\n\n    start () {\n        // [3]\n    }\n\n/**\n * 展示血条\n *\n * @param {*} scriptParent \n * @param {number} totalBlood\n * @param {Vec3} offsetPos\n * @param {Vec3} scale\n * @param {(Function | null)} [callback]\n * @param {boolean} [isInit=true]\n * @memberof MonsterBloodBar\n */\npublic show (scriptParent: any, totalBlood: number, offsetPos: Vec3, scale: Vec3, callback?: Function | null, isInit: boolean = true) {\n        this._scriptParent = scriptParent;\n        this._totalBlood = totalBlood * GameManager.hpAddition;\n        this._offsetPos = offsetPos;\n        this._ndTarget = scriptParent.node;\n        this._isBloodEmpty = false;\n\n        this._prevBloodPos.set(this._ndTarget.worldPosition);\n\n        if (isInit) {\n            this._curBlood = this._totalBlood;\n        }\n\n        //当前血量占全部的比例\n        let ratio = this._curBlood / this._totalBlood;\n        ratio = clamp(ratio, 0, 1);\n\n        //进度条宽度设置\n        this.UIComWhiteBar.setContentSize(ratio * this._maxWhiteBarWidth, this._whiteBarHeight);\n        this.UIComRedBar.setContentSize(ratio * this._maxRedBarWidth, this._redBarHeight);\n\n        this.UIComBloodBar.priority = constant.PRIORITY.BLOOD;\n\n        callback && callback();\n    }\n\n    /**\n     * 刷新血量\n     *\n     * @param {number} num 血量值\n     * @memberof MonsterBloodBar\n     */\n    public refreshBlood (num: number) {\n        this._curBlood += num;\n\n        let ratio = this._curBlood / this._totalBlood;\n\n        if (num < 0) {//减血\n            ratio = ratio <= 0 ? 0 : ratio;\n    \n            this.UIComRedBar.setContentSize(this._maxRedBarWidth * ratio, this._redBarHeight);\n\n            if (!this._isBloodEmpty) {\n                this._isBloodEmpty = ratio <= 0;\n\n                tween(this.UIComWhiteBar)\n                .to(0.7, {width: this._maxWhiteBarWidth * ratio})\n                .call(()=>{\n                    if (this._isBloodEmpty) {\n                        poolManager.instance.putNode(this.node);\n                    }\n                })\n                .start();\n\n                if (this._isBloodEmpty) {\n                    this._scriptParent.isDie = true;\n                }\n            } else {\n                poolManager.instance.putNode(this.node);\n                this._scriptParent.isDie = true;\n            }\n        } \n    }\n\n    update () {\n        if (this.node.parent && this.node.active && this._ndTarget && this._ndTarget.parent) {\n            let worPos = this._ndTarget.worldPosition;\n            if (this._isBloodEmpty) {\n                worPos = this._prevBloodPos;\n            } else {\n                this._prevBloodPos.set(worPos);\n            }\n\n            GameManager.mainCamera?.convertToUINode(worPos, find(\"Canvas\") as Node, this._curPos);\n            this._curPos.add(this._offsetPos);\n            this.node.setPosition(this._curPos);\n        }\n    }\n}\n"]}