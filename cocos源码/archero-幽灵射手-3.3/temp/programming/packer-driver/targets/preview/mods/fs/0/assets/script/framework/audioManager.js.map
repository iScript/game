{"version":3,"sources":["file:///Users/ykq/Downloads/archero/assets/script/framework/audioManager.ts"],"names":["_decorator","Node","AudioClip","AudioSource","game","director","StorageManager","resourceUtil","lodash","ccclass","property","AudioManager","init","_persistRootNode","getScene","addChild","addPersistRootNode","musicVolume","getAudioSetting","soundVolume","_getAudioSource","clip","result","i","_audioSources","length","audioSource","playing","addComponent","push","node","off","EventType","ENDED","currentTime","isMusic","state","instance","getGlobalData","playMusic","name","loop","path","loadRes","err","source","tmp","audios","volume","play","playSound","arrSound","on","remove","obj","stop","hasOwnProperty","audio","stopAll","getMusicVolume","setMusic","flag","item","pauseAll","console","log","pause","resumeAll","openMusic","setGlobalData","closeMusic","openSound","setSound","closeSound","idx","stopSingleSound","_instance"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AACSA,MAAAA,U,OAAAA,U;AAAuBC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,S,OAAAA,S;AAAgBC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,Q,OAAAA,Q;;AAChEC,MAAAA,c,iBAAAA,c;;AACAC,MAAAA,Y,iBAAAA,Y;;AACAC,MAAAA,M,iBAAAA,M;;;;;;;AACDC,MAAAA,O,GAAsBT,U,CAAtBS,O;AAASC,MAAAA,Q,GAAaV,U,CAAbU,Q;;8BAYJC,Y,WADZF,OAAO,CAAC,cAAD,C;;oDAE6B,I;;iDACM,E;;wDAEX,E;;+CAWN,G;;+CACA,C;;0CACC,E;;4CACC,E;;;;;eAExBG,I,GAAA,gBAAO;AACH,cAAI,KAAKC,gBAAT,EAA2B,OADxB,CACgC;;AACnC,eAAKA,gBAAL,GAAwB,IAAIZ,IAAJ,CAAS,OAAT,CAAxB;AACAI,UAAAA,QAAQ,CAACS,QAAT,GAAqBC,QAArB,CAA8B,KAAKF,gBAAnC;AACAT,UAAAA,IAAI,CAACY,kBAAL,CAAwB,KAAKH,gBAA7B;AAEA,eAAKI,WAAL,GAAmB,KAAKC,eAAL,CAAqB,IAArB,IAA6B,GAA7B,GAAmC,CAAtD;AACA,eAAKC,WAAL,GAAmB,KAAKD,eAAL,CAAqB,KAArB,IAA8B,CAA9B,GAAkC,CAArD;AACH,S;;eAEOE,e,GAAR,yBAAwBC,IAAxB,EAAyC;AACrC,cAAIC,MAAJ;;AACA,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKC,aAAL,CAAmBC,MAAvC,EAA+C,EAAEF,CAAjD,EAAoD;AAChD,gBAAIG,WAAW,GAAG,KAAKF,aAAL,CAAmBD,CAAnB,CAAlB;;AACA,gBAAI,CAACG,WAAW,CAACC,OAAjB,EAA0B;AACtBL,cAAAA,MAAM,GAAGI,WAAT;AACA;AACH;AACJ;;AACD,cAAI,CAACJ,MAAL,EAAa;AACTA,YAAAA,MAAM,GAAG,KAAKT,gBAAL,CAAsBe,YAAtB,CAAmCzB,WAAnC,CAAT;;AACA,iBAAKqB,aAAL,CAAmBK,IAAnB,CAAwBP,MAAxB;AACH;;AACDA,UAAAA,MAAM,CAACQ,IAAP,CAAYC,GAAZ,CAAgB5B,WAAW,CAAC6B,SAAZ,CAAsBC,KAAtC;AACAX,UAAAA,MAAM,CAACD,IAAP,GAAcA,IAAd;AACAC,UAAAA,MAAM,CAACY,WAAP,GAAqB,CAArB;AACA,iBAAOZ,MAAP;AACH,S;;eAEDJ,e,GAAA,yBAAgBiB,OAAhB,EAAkC;AAC9B,cAAIC,KAAJ;;AACA,cAAID,OAAJ,EAAa;AACTC,YAAAA,KAAK,GAAG;AAAA;AAAA,kDAAeC,QAAf,CAAwBC,aAAxB,CAAsC,OAAtC,CAAR;AACH,WAFD,MAEO;AACHF,YAAAA,KAAK,GAAG;AAAA;AAAA,kDAAeC,QAAf,CAAwBC,aAAxB,CAAsC,OAAtC,CAAR;AACH,WAN6B,CAQ9B;;;AAEA,iBAAO,CAACF,KAAD,IAAUA,KAAK,KAAK,MAApB,GAA6B,IAA7B,GAAoC,KAA3C;AACH;AAED;AACJ;AACA;AACA;AACA;;;eACIG,S,GAAA,mBAAUC,IAAV,EAAwBC,IAAxB,EAAuC;AAAA;;AACnC,cAAIC,IAAI,GAAG,iBAAiBF,IAA5B,CADmC,CAEnC;AACA;AACA;AACA;;AAGA;AAAA;AAAA,4CAAaG,OAAb,CAAqBD,IAArB,EAA2BxC,SAA3B,EAAsC,UAAC0C,GAAD,EAAWvB,IAAX,EAAyB;AAC3D,gBAAIwB,MAAM,GAAG,KAAI,CAACzB,eAAL,CAAqBC,IAArB,CAAb;;AACA,gBAAIyB,GAAc,GAAG;AACjBD,cAAAA,MAAM,EAANA,MADiB;AAEjBV,cAAAA,OAAO,EAAE;AAFQ,aAArB;AAIA,YAAA,KAAI,CAACY,MAAL,CAAYP,IAAZ,IAAoBM,GAApB;AACAD,YAAAA,MAAM,CAACG,MAAP,GAAgB,KAAI,CAAC/B,WAArB;AACA4B,YAAAA,MAAM,CAACJ,IAAP,GAAcA,IAAd;AACAI,YAAAA,MAAM,CAACI,IAAP;AACH,WAVD;AAWH;AAED;AACJ;AACA;AACA;AACA;;;eACIC,S,GAAA,mBAAUV,IAAV,EAAwBC,IAAxB,EAA+C;AAAA;;AAAA,cAAvBA,IAAuB;AAAvBA,YAAAA,IAAuB,GAAP,KAAO;AAAA;;AAC3C,cAAI,CAAC,KAAKtB,WAAV,EAAuB;AACnB;AACH,WAH0C,CAK3C;;;AACA,cAAIuB,IAAI,GAAG,cAAX,CAN2C,CAO3C;AACA;AACA;;AAEA;AAAA;AAAA,4CAAaC,OAAb,CAAqBD,IAAI,GAAGF,IAA5B,EAAkCtC,SAAlC,EAA6C,UAAC0C,GAAD,EAAWvB,IAAX,EAAyB;AAClE,gBAAIwB,MAAM,GAAG,MAAI,CAACzB,eAAL,CAAqBC,IAArB,CAAb;;AACA,gBAAIyB,GAAc,GAAG;AACjBD,cAAAA,MAAM,EAANA,MADiB;AAEjBV,cAAAA,OAAO,EAAE;AAFQ,aAArB;;AAIA,YAAA,MAAI,CAACgB,QAAL,CAActB,IAAd,CAAmBiB,GAAnB;;AAEA,gBAAIL,IAAJ,EAAU;AACN,cAAA,MAAI,CAACM,MAAL,CAAYP,IAAZ,IAAoBM,GAApB;AACH;;AAEDD,YAAAA,MAAM,CAACG,MAAP,GAAgB,MAAI,CAAC7B,WAArB;AACA0B,YAAAA,MAAM,CAACJ,IAAP,GAAcA,IAAd;AACAI,YAAAA,MAAM,CAACI,IAAP;AAEAJ,YAAAA,MAAM,CAACf,IAAP,CAAYsB,EAAZ,CAAejD,WAAW,CAAC6B,SAAZ,CAAsBC,KAArC,EAA4C,YAAM;AAC9C;AAAA;AAAA,oCAAOoB,MAAP,CAAc,MAAI,CAACF,QAAnB,EAA6B,UAACG,GAAD,EAAoB;AAC7C,uBAAOA,GAAG,CAACT,MAAJ,KAAeC,GAAG,CAACD,MAA1B;AACH,eAFD;AAGH,aAJD;AAKH,WArBD;AAsBH,S;;eAEDU,I,GAAA,cAAKf,IAAL,EAAmB;AACf,cAAI,KAAKO,MAAL,CAAYS,cAAZ,CAA2BhB,IAA3B,CAAJ,EAAsC;AAClC,gBAAIiB,KAAK,GAAG,KAAKV,MAAL,CAAYP,IAAZ,CAAZ;AACAiB,YAAAA,KAAK,CAACZ,MAAN,CAAaU,IAAb;AACH;AACJ,S;;eAEDG,O,GAAA,mBAAU;AACN,eAAK,IAAMnC,CAAX,IAAgB,KAAKwB,MAArB,EAA6B;AACzB,gBAAI,KAAKA,MAAL,CAAYS,cAAZ,CAA2BjC,CAA3B,CAAJ,EAAmC;AAC/B,kBAAIkC,KAAK,GAAG,KAAKV,MAAL,CAAYxB,CAAZ,CAAZ;AACAkC,cAAAA,KAAK,CAACZ,MAAN,CAAaU,IAAb;AACH;AACJ;AACJ,S;;eACDI,c,GAAA,0BAAiB;AACb,iBAAO,KAAK1C,WAAZ;AACH,S;;eAED2C,Q,GAAA,kBAASC,IAAT,EAAuB;AACnB,eAAK5C,WAAL,GAAmB4C,IAAnB;;AACA,eAAK,IAAIC,IAAT,IAAiB,KAAKf,MAAtB,EAA8B;AAC1B,gBAAI,KAAKA,MAAL,CAAYS,cAAZ,CAA2BM,IAA3B,KAAoC,KAAKf,MAAL,CAAYe,IAAZ,EAAkB3B,OAA1D,EAAmE;AAC/D;AACA,kBAAIsB,KAAK,GAAG,KAAKV,MAAL,CAAYe,IAAZ,CAAZ;AACAL,cAAAA,KAAK,CAACZ,MAAN,CAAaG,MAAb,GAAsB,KAAK/B,WAA3B;AACH;AACJ;AACJ,S,CAED;;;eACA8C,Q,GAAA,oBAAW;AACPC,UAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ;;AAEA,eAAK,IAAIH,IAAT,IAAiB,KAAKf,MAAtB,EAA8B;AAC1B,gBAAI,KAAKA,MAAL,CAAYS,cAAZ,CAA2BM,IAA3B,CAAJ,EAAsC;AAClC,kBAAIL,KAAK,GAAG,KAAKV,MAAL,CAAYe,IAAZ,CAAZ;AACAL,cAAAA,KAAK,CAACZ,MAAN,CAAaqB,KAAb;AACH;AACJ;AACJ,S;;eAEDC,S,GAAA,qBAAY;AACR,eAAK,IAAIL,IAAT,IAAiB,KAAKf,MAAtB,EAA8B;AAC1B,gBAAI,KAAKA,MAAL,CAAYS,cAAZ,CAA2BM,IAA3B,CAAJ,EAAsC;AAClC,kBAAIL,KAAK,GAAG,KAAKV,MAAL,CAAYe,IAAZ,CAAZ;AACAL,cAAAA,KAAK,CAACZ,MAAN,CAAaI,IAAb;AACH;AACJ;AACJ,S;;eAEDmB,S,GAAA,qBAAY;AACR,eAAKR,QAAL,CAAc,GAAd;AACA;AAAA;AAAA,gDAAevB,QAAf,CAAwBgC,aAAxB,CAAsC,OAAtC,EAA+C,MAA/C;AACH,S;;eAEDC,U,GAAA,sBAAa;AACT,eAAKV,QAAL,CAAc,CAAd;AACA;AAAA;AAAA,gDAAevB,QAAf,CAAwBgC,aAAxB,CAAsC,OAAtC,EAA+C,OAA/C;AACH,S;;eAEDE,S,GAAA,qBAAY;AACR,eAAKC,QAAL,CAAc,CAAd;AACA;AAAA;AAAA,gDAAenC,QAAf,CAAwBgC,aAAxB,CAAsC,OAAtC,EAA+C,MAA/C;AACH,S;;eAEDI,U,GAAA,sBAAa;AACT,eAAKD,QAAL,CAAc,CAAd;AACA;AAAA;AAAA,gDAAenC,QAAf,CAAwBgC,aAAxB,CAAsC,OAAtC,EAA+C,OAA/C;AACH,S;;eAEDG,Q,GAAA,kBAASX,IAAT,EAAuB;AACnB,eAAK1C,WAAL,GAAmB0C,IAAnB;;AACA,eAAK,IAAIC,IAAT,IAAiB,KAAKf,MAAtB,EAA8B;AAC1B,gBAAI,KAAKA,MAAL,CAAYS,cAAZ,CAA2BM,IAA3B,KAAoC,CAAC,KAAKf,MAAL,CAAYe,IAAZ,EAAkB3B,OAA3D,EAAoE;AAChE;AACA,kBAAIsB,KAAK,GAAG,KAAKV,MAAL,CAAYe,IAAZ,CAAZ;AACAL,cAAAA,KAAK,CAACZ,MAAN,CAAaG,MAAb,GAAsB,KAAK7B,WAA3B;AACH;AACJ;;AAED,eAAK,IAAIuD,GAAG,GAAG,CAAf,EAAkBA,GAAG,GAAG,KAAKvB,QAAL,CAAc1B,MAAtC,EAA8CiD,GAAG,EAAjD,EAAqD;AACjD,gBAAIjB,MAAK,GAAG,KAAKN,QAAL,CAAcuB,GAAd,CAAZ;AACAjB,YAAAA,MAAK,CAACZ,MAAN,CAAaG,MAAb,GAAsB,KAAK7B,WAA3B;AACH;AACJ,S;;eAEDwD,e,GAAA,yBAAgBnC,IAAhB,EAA8B;AAC1B,cAAI,KAAKO,MAAL,CAAYS,cAAZ,CAA2BhB,IAA3B,KAAoC,CAAC,KAAKO,MAAL,CAAYP,IAAZ,EAAkBL,OAA3D,EAAoE;AAChE,gBAAIsB,KAAK,GAAG,KAAKV,MAAL,CAAYP,IAAZ,CAAZ;AACAiB,YAAAA,KAAK,CAACZ,MAAN,CAAaU,IAAb;AACH;AACJ,S;;;;eAtND,eAAsB;AAClB,gBAAI,KAAKqB,SAAT,EAAoB;AAChB,qBAAO,KAAKA,SAAZ;AACH;;AAED,iBAAKA,SAAL,GAAiB,IAAIjE,YAAJ,EAAjB;AACA,mBAAO,KAAKiE,SAAZ;AACH","sourcesContent":["import { util } from './util';\nimport { _decorator, Component, Node, AudioClip, sys, AudioSource, game, director } from \"cc\";\nimport { StorageManager } from \"./storageManager\";\nimport { resourceUtil } from \"./resourceUtil\";\nimport { lodash } from './lodash';\nconst { ccclass, property } = _decorator;\n\ninterface AudioData {\n    source: AudioSource;\n    isMusic: boolean;\n}\n\ninterface AudioDataMap {\n    [name: string]: AudioData;\n}\n\n@ccclass(\"AudioManager\")\nexport class AudioManager {\n    private _persistRootNode: Node = null!;\n    private _audioSources: AudioSource[] = [];\n    static _instance: AudioManager;\n    dictWeaponSoundIndex: any = {};\n\n    static get instance() {\n        if (this._instance) {\n            return this._instance;\n        }\n\n        this._instance = new AudioManager();\n        return this._instance;\n    }\n\n    musicVolume: number = 0.8;\n    soundVolume: number = 1;\n    audios: AudioDataMap = {};\n    arrSound: AudioData[] = [];\n\n    init() {\n        if (this._persistRootNode) return; //避免切换场景初始化报错\n        this._persistRootNode = new Node('audio');\n        director.getScene()!.addChild(this._persistRootNode);\n        game.addPersistRootNode(this._persistRootNode)\n\n        this.musicVolume = this.getAudioSetting(true) ? 0.8 : 0;\n        this.soundVolume = this.getAudioSetting(false) ? 1 : 0;\n    }\n\n    private _getAudioSource(clip: AudioClip) {\n        let result: AudioSource | undefined;\n        for (let i = 0; i < this._audioSources.length; ++i) {\n            let audioSource = this._audioSources[i];\n            if (!audioSource.playing) {\n                result = audioSource;\n                break;\n            }\n        }\n        if (!result) {\n            result = this._persistRootNode.addComponent(AudioSource);\n            this._audioSources.push(result);\n        }\n        result.node.off(AudioSource.EventType.ENDED);\n        result.clip = clip;\n        result.currentTime = 0;\n        return result;\n    }\n\n    getAudioSetting(isMusic: boolean) {\n        let state;\n        if (isMusic) {\n            state = StorageManager.instance.getGlobalData('music');\n        } else {\n            state = StorageManager.instance.getGlobalData('sound');\n        }\n\n        // console.log('Config for [' + (isMusic ? 'Music' : 'Sound') + '] is ' + state);\n\n        return !state || state === 'true' ? true : false;\n    }\n\n    /**\n     * 播放音乐\n     * @param {String} name 音乐名称可通过constants.AUDIO_MUSIC 获取\n     * @param {Boolean} loop 是否循环播放\n     */\n    playMusic(name: string, loop: boolean) {\n        let path = 'audio/music/' + name;\n        //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // if (name !== 'click') {\n        //     path =  path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // }\n\n\n        resourceUtil.loadRes(path, AudioClip, (err: any, clip: any) => {\n            let source = this._getAudioSource(clip);\n            let tmp: AudioData = {\n                source,\n                isMusic: true,\n            };\n            this.audios[name] = tmp;\n            source.volume = this.musicVolume;\n            source.loop = loop;\n            source.play();\n        });\n    }\n\n    /**\n     * 播放音效\n     * @param {String} name 音效名称可通过constants.AUDIO_SOUND 获取\n     * @param {Boolean} loop 是否循环播放\n     */\n    playSound(name: string, loop: boolean = false) {\n        if (!this.soundVolume) {\n            return;\n        }\n\n        //音效一般是多个的，不会只有一个\n        let path = 'audio/sound/';\n        // if (name !== 'click') {\n        //     path = path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // }\n\n        resourceUtil.loadRes(path + name, AudioClip, (err: any, clip: any) => {\n            let source = this._getAudioSource(clip);\n            let tmp: AudioData = {\n                source,\n                isMusic: false,\n            };\n            this.arrSound.push(tmp);\n\n            if (loop) {\n                this.audios[name] = tmp;\n            }\n\n            source.volume = this.soundVolume;\n            source.loop = loop;\n            source.play();\n\n            source.node.on(AudioSource.EventType.ENDED, () => {\n                lodash.remove(this.arrSound, (obj: AudioData) => {\n                    return obj.source === tmp.source;\n                });\n            });\n        });\n    }\n\n    stop(name: string) {\n        if (this.audios.hasOwnProperty(name)) {\n            let audio = this.audios[name];\n            audio.source.stop();\n        }\n    }\n\n    stopAll() {\n        for (const i in this.audios) {\n            if (this.audios.hasOwnProperty(i)) {\n                let audio = this.audios[i];\n                audio.source.stop();\n            }\n        }\n    }\n    getMusicVolume() {\n        return this.musicVolume;\n    }\n\n    setMusic(flag: number) {\n        this.musicVolume = flag;\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item) && this.audios[item].isMusic) {\n                // this.changeState(item, flag);\n                let audio = this.audios[item];\n                audio.source.volume = this.musicVolume;\n            }\n        }\n    }\n\n    //看广告时先将音乐暂停\n    pauseAll() {\n        console.log(\"pause all music!!!\");\n\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item)) {\n                let audio = this.audios[item];\n                audio.source.pause();\n            }\n        }\n    }\n\n    resumeAll() {\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item)) {\n                let audio = this.audios[item];\n                audio.source.play();\n            }\n        }\n    }\n\n    openMusic() {\n        this.setMusic(0.8);\n        StorageManager.instance.setGlobalData('music', 'true');\n    }\n\n    closeMusic() {\n        this.setMusic(0);\n        StorageManager.instance.setGlobalData('music', 'false');\n    }\n\n    openSound() {\n        this.setSound(1);\n        StorageManager.instance.setGlobalData('sound', 'true');\n    }\n\n    closeSound() {\n        this.setSound(0);\n        StorageManager.instance.setGlobalData('sound', 'false');\n    }\n\n    setSound(flag: number) {\n        this.soundVolume = flag;\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item) && !this.audios[item].isMusic) {\n                // this.changeState(item, flag);\n                let audio = this.audios[item];\n                audio.source.volume = this.soundVolume;\n            }\n        }\n\n        for (let idx = 0; idx < this.arrSound.length; idx++) {\n            let audio = this.arrSound[idx];\n            audio.source.volume = this.soundVolume;\n        }\n    }\n\n    stopSingleSound(name: string) {\n        if (this.audios.hasOwnProperty(name) && !this.audios[name].isMusic) {\n            let audio = this.audios[name];\n            audio.source.stop();\n        }\n    }\n}\n"]}