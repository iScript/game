{"version":3,"sources":["file:///Users/ykq/Downloads/archero/assets/script/fight/reward.ts"],"names":["_decorator","Component","Vec3","Quat","clamp","tween","Enum","EffectManager","util","poolManager","constant","clientEvent","GameManager","resourceUtil","AudioManager","REWARD_TYPE","GOLD","HEART","ccclass","property","Reward","type","displayOrder","onEnable","on","EVENT_TYPE","INHALE_REWARD","_inhaleReward","onDisable","off","start","init","time","ndParent","_ndParent","_oriScale","node","setScale","getScale","_isAutoRotate","_isInhaling","_curSpeedY","_upSpeedY","_oriWorPos","set","getWorldPosition","x","z","_isArriveMinPos","isDropOver","_totalFlyTime","_curFlyTime","_raiseTimes","scheduleOnce","show","_ndTrial","loadEffectRes","then","pf","instance","getNode","active","_trialScale","setPosition","_trialPos","Math","random","y","_endTargetPos","add3f","_midTargetPos","playSound","SOUND","GOLD_DROP","_checkMonsterClearOver","ndTarget","getNearestMonster","arrReward","children","filter","ndChild","name","isAllDropOver","every","ndReward","scriptReward","getComponent","console","log","dispatchEvent","_closeTween","_tweenBounce","by","position","_bouncePos","scale","_bounceScale","easing","call","playTrail","stop","_checkInhaleOver","isNoReward","GOLD_COLLECT","SHOW_WARP_GATE","update","deltaTime","_rewardWorPos","_stepTargetPos","lerp","_nextWorPos","_downSpeedY","equals","fromEuler","_curQuat","rotate","_playerWorPos","scriptPlayer","worldPosition","subtract","_offsetPos","length","offset","pow","percent","Number","toFixed","_targetWorPos","setWorldPosition","putNode","rewardType","addGold","bloodNum","curHpLimit","addBlood"],"mappings":"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","sourcesContent":["import { EffectManager } from './../framework/effectManager';\nimport { util } from './../framework/util';\nimport { poolManager } from './../framework/poolManager';\nimport { constant } from './../framework/constant';\nimport { _decorator, Component, Node, Vec3, RigidBodyComponent, Quat, ParticleSystemComponent, clamp, Details, tween, Enum, Game } from 'cc';\nimport { clientEvent } from '../framework/clientEvent';\nimport { GameManager } from './gameManager';\nimport { resourceUtil } from '../framework/resourceUtil';\nimport { AudioManager } from '../framework/audioManager';\n//奖品(奖励)组件：金币和爱心\n\n//奖励类型\nconst REWARD_TYPE = Enum ({\n    GOLD: 1,//金币\n    HEART: 2,//爱心\n})\nconst { ccclass, property } = _decorator;\n@ccclass('Reward')\nexport class Reward extends Component {\n    @property({\n        type: REWARD_TYPE,\n        displayOrder: 1\n    })\n    public rewardType: any = REWARD_TYPE.GOLD;\n    public isDropOver: boolean = false;//是否已经落在地上\n\n    private _trialScale = new Vec3(3, 3, 3);//拖尾缩放\n    private _trialPos: Vec3 = new Vec3(0, -0.1, 0);//拖尾位置\n    private _tweenBounce: any = null!;//tween\n    private _curQuat: Quat = new Quat();//旋转\n    private _isAutoRotate: boolean = false;//是否自动旋转\n    private _isInhaling: boolean = false;//是否正在吸入中\n    private _oriScale: Vec3 = null!;//原始缩放大小\n    private _ndParent: Node = null!;//父亲节点\n    private _ndTrial: Node = null!;//拖尾节点\n    private _endTargetPos:Vec3 = new Vec3();//最终目标位置\n    private _midTargetPos: Vec3 = new Vec3();//中间位置\n    private _stepTargetPos: Vec3 = new Vec3();//下一次的位置\n    private _upSpeedY: number = 0.2;//上升最大速度\n    private _downSpeedY: number = 0.2;//下降最大速度\n    private _curSpeedY: number = 0;//当前速度\n    private _oriWorPos: Vec3 = new Vec3();//初始奖品世界坐标\n    private _isArriveMinPos: boolean = false;//已经到达中间位置\n    private _rewardWorPos: Vec3 = new Vec3();//当前奖品世界坐标\n    private _playerWorPos: Vec3 = new Vec3();//目标(主角)位置\n    private _nextWorPos: Vec3 = new Vec3();//下一个位置\n    private _offsetPos: Vec3 = new Vec3();//奖品和玩家之间的向量差\n    private _targetWorPos: Vec3 = new Vec3();//\n    private _totalFlyTime: number = 0;//奖品总飞行时间\n    private _curFlyTime: number = 0;//奖品当前飞行时间\n    private _raiseTimes: number = 1;//\n    private _bouncePos: Vec3 = new Vec3(0, 0.618, 0);//回收缓动高度\n    private _bounceScale: Vec3 = new Vec3(0.2, 0.2, 0.2);//回收缓动缩放\n\n    onEnable () {\n        clientEvent.on(constant.EVENT_TYPE.INHALE_REWARD, this._inhaleReward, this);\n    }\n\n    onDisable () {\n        clientEvent.off(constant.EVENT_TYPE.INHALE_REWARD, this._inhaleReward, this);\n    }\n\n    start () {\n      \n    }\n\n    init (time: number, ndParent: Node) {\n        this._ndParent = ndParent;\n\n        if (this._oriScale) {\n            this.node.setScale(this._oriScale);\n        } else {\n            this._oriScale = this.node.getScale();\n        }\n\n        this._isAutoRotate = false;\n        this._isInhaling = false;\n        this._curSpeedY = this._upSpeedY;\n        this._oriWorPos.set(this.node.getWorldPosition().x, 1.65, this.node.getWorldPosition().z);\n        this._isArriveMinPos = false;\n        this.isDropOver = false;\n        this._totalFlyTime = 0;\n        this._curFlyTime = 0;\n        this._raiseTimes = 1;\n\n        //依次弹出奖品\n        this.scheduleOnce(()=>{\n            this.show();\n        }, time)\n\n        if (!this._ndTrial) {\n            resourceUtil.loadEffectRes(\"trail/coinTrail\").then((pf: any)=>{\n                this._ndTrial = poolManager.instance.getNode(pf, this.node);\n                this._ndTrial.active = false;    \n                this._ndTrial.setScale(this._trialScale);\n                this._ndTrial.setPosition(this._trialPos);\n            });\n        } else {\n            this._ndTrial.active = false;\n        }\n    }\n\n    show () {\n        this.node.active = true;\n        let x = Math.random() * 6 - 3;//-3~3\n        let y = 4;//最高的高度4~4.5;\n        let z = Math.random() * 6 - 3;//-3~3\n        this._endTargetPos = this._endTargetPos.set(this._oriWorPos).add3f(x, 0, z);\n        this._midTargetPos = this._midTargetPos.set(this._oriWorPos).add3f(x/2, y, z/2);\n\n        // console.log(\"终点位置\", this._endTargetPos, \"中间位置\", this._midTargetPos);\n\n        AudioManager.instance.playSound(constant.SOUND.GOLD_DROP);  \n    }\n\n    /**\n     * 检查所有敌人是否已经击败，且奖品是否都全部掉落完毕\n     *\n     * @protected\n     * @memberof Reward\n     */\n    protected _checkMonsterClearOver () {\n        let ndTarget = GameManager.getNearestMonster();\n\n        if (!ndTarget) {\n            let arrReward = this._ndParent.children.filter((ndChild: Node)=>{\n                return ndChild.name === \"gold\" || ndChild.name === \"heart\";\n            })\n\n            let isAllDropOver = arrReward.every((ndReward: Node) => {\n                let scriptReward = ndReward.getComponent(Reward) as Reward;\n                return scriptReward.isDropOver === true;\n            });\n\n            if (isAllDropOver) {\n                console.log(\"###所有的奖品都已经掉落到地上了\");\n                clientEvent.dispatchEvent(constant.EVENT_TYPE.INHALE_REWARD);\n            }\n        }\n    }\n\n    /**\n     * 玩家吸入奖品\n     *\n     * @protected\n     * @memberof Reward\n     */\n    protected _inhaleReward () {\n        //先弹跳\n        this._closeTween();\n        this._tweenBounce = tween(this.node)\n        .by(0.3, {position: this._bouncePos, scale: this._bounceScale}, {easing: \"bounceInOut\"})\n        .call(()=>{\n            //播放粒子特效，不要勾选粒子的prewarm属性，免得出现概率性没有播放拖尾\n            this._ndTrial.active = true;\n            EffectManager.instance.playTrail(this._ndTrial);\n            \n            //再吸入\n            this._isInhaling = true;\n            \n        })\n        .start()\n    }\n\n    protected _closeTween () {\n        if (this._tweenBounce) {\n            this._tweenBounce.stop();\n            this._tweenBounce = null!;\n        }\n    }\n\n    /**\n     *  检查所有奖品是否吸收完毕\n     *\n     * @protected\n     * @memberof Reward\n     */\n    protected _checkInhaleOver () {\n        let isNoReward = this._ndParent.children.every((ndChild: Node)=>{\n            return ndChild.name !== \"gold\" && ndChild.name === \"heart\";\n        })\n\n        if (isNoReward) {\n            console.log(\"###已吸入全部奖品\");\n            AudioManager.instance.playSound(constant.SOUND.GOLD_COLLECT);\n            clientEvent.dispatchEvent(constant.EVENT_TYPE.SHOW_WARP_GATE);\n        }\n    }\n\n    update (deltaTime: number) {\n        //奖品上下弹跳\n        if (!this.isDropOver) {\n            this._rewardWorPos.set(this.node.position);\n            //先抬高\n            if (!this._isArriveMinPos) {\n                this._stepTargetPos = this._rewardWorPos.lerp(this._midTargetPos, 0.03);\n                this._curSpeedY = util.lerp(this._upSpeedY, this._curSpeedY, 0.03);\n                this._nextWorPos = this._nextWorPos.set(this._stepTargetPos).add3f(0, this._curSpeedY, 0);\n                this._nextWorPos.y = clamp(this._nextWorPos.y, 0, this._midTargetPos.y);\n                this.node.setPosition(this._nextWorPos);\n    \n                // if (pos.equals(this._midTargetPos, 0.2)) {\n                if (this._nextWorPos.y >= this._midTargetPos.y) {\n                    this._isArriveMinPos = true;\n                    this._curSpeedY = 0;\n                    // console.log(\"到达中间位置\");\n                }\n            } else {//后降落\n                this._stepTargetPos = this._rewardWorPos.lerp(this._endTargetPos, 0.02);\n                this._curSpeedY = util.lerp(this._downSpeedY, this._curSpeedY, 0.05);\n                // console.log(\"_upSpeedY\", this._curSpeedY);\n                this._nextWorPos = this._nextWorPos.set(this._stepTargetPos).add3f(0, -this._curSpeedY, 0);\n                this._nextWorPos.y = clamp(this._nextWorPos.y, this._endTargetPos.y, this._midTargetPos.y);\n                this.node.setPosition(this._nextWorPos);\n\n                if (this._nextWorPos.equals(this._endTargetPos, 0.3)) {\n                    this.isDropOver = true;\n                    // console.log(\"到达地板上\");\n                    this._isAutoRotate = true;\n                    this._checkMonsterClearOver();\n                }\n            }\n        }\n\n        //奖品落地后自动旋转\n        if (this._isAutoRotate) {\n            Quat.fromEuler(this._curQuat, 0, 120 * deltaTime, 0);\n            this.node.rotate(this._curQuat);\n        }\n\n        //奖品被玩家吸入\n        if (this._isInhaling) {\n            //位置靠近玩家\n            this._playerWorPos.set(GameManager.scriptPlayer.node.worldPosition);\n            this._rewardWorPos.set(this.node.worldPosition);\n            //向量差\n            Vec3.subtract(this._offsetPos, this._playerWorPos, this._rewardWorPos);\n\n            if (!this._totalFlyTime) {\n                this._totalFlyTime = this._offsetPos.length() / 2;\n            }\n\n            // 由慢到快\n            this._raiseTimes += deltaTime;\n            let offset = Math.pow(this._raiseTimes, 0.5) - 1;\n            this._curFlyTime += deltaTime + offset;\n            this._curFlyTime = this._curFlyTime >= this._totalFlyTime ? this._totalFlyTime : this._curFlyTime;\n\n            let percent = Number((this._curFlyTime / this._totalFlyTime).toFixed(2));\n            // console.log(\"percent\", percent);\n\n            this._targetWorPos.set(this._rewardWorPos.x + this._offsetPos.x * percent, this._playerWorPos.y, this._rewardWorPos.z + this._offsetPos.z * percent);\n            this.node.setWorldPosition(this._targetWorPos);\n\n            if (this._targetWorPos.equals(this._playerWorPos, 0.1)) {\n                this._isInhaling = false;\n                this._ndTrial.active = false;\n                poolManager.instance.putNode(this.node);\n\n                if (this.rewardType === REWARD_TYPE.GOLD) {\n                    GameManager.addGold();\n                } else if (this.rewardType === REWARD_TYPE.HEART) {\n                    //回复5%的血量\n                    let bloodNum = GameManager.scriptPlayer.curHpLimit * 0.05;\n                    GameManager.scriptPlayer.addBlood(bloodNum);\n                }\n\n                this._checkInhaleOver();\n                // console.log(\"吸收奖品\");\n            }\n        }\n    }\n}\n"]}